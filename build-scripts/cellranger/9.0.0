#!/usr/bin/bash
#SBATCH --cpus-per-task=1
#SBATCH --time=6:00:00
#SBATCH --mem=2GB
#SBATCH --job-name=make
#SBATCH --output=build_%j.out

# You need to change the line 104: https://www.10xgenomics.com/support/software/cell-ranger/downloads/previous-versions
ncpu=${SLURM_CPUS_PER_TASK:-1} # number of cores to use

#region CONFIGS
# Define color codes
RED='\033[0;31m'
NC='\033[0m'     # No Color

if ! [ -d build-scripts ]; then
    printf "Please run this script under ${RED}modules${NC} directory.\n"
    printf "And make sure you have your scripts in build-scripts folder.\n"
    printf "    e.g. bash build-scripts/sra-tools/3.1.1\n"
    exit
fi

modules_root="$(pwd -P)"
script_path="$(realpath "$0")"
app_name_version="${script_path#*/build-scripts/}" # app/version
app_name="${app_name_version%/*}"                  # app
version="${app_name_version##*/}"                  # version

app_base_dir="${modules_root}/${app_name}"         # modules/app
target_dir="${modules_root}/${app_name_version}"   # modules/app/version
script_base_dir="${modules_root}/modulefiles/${app_name}"        # modulefiles/app
script_path="${modules_root}/modulefiles/${app_name_version}"    # modulefiles/app/version

# Parse the parameters
while getopts ":hd" opt; do
    case ${opt} in
        h )
            echo "Usage: bash $0 [-h]"
            echo "Options:"
            echo "  -h  Display this help message."
            echo "  -d  Delete the target module."
            exit 0
            ;;
        d )
            printf "[`date +"%Y-%m-%d %T"`] Deleting the target module: $target_dir\n"
            # if target directory does not exist, exit 1
            if [ ! -d "$target_dir" ]; then
                printf "[`date +"%Y-%m-%d %T"`] ${RED}ERROR${NC}: Target app does not exist!\n"  1>&2
                printf "[`date +"%Y-%m-%d %T"`] Exit Removing\n"
                exit 1
            fi
            
            # modules/app/version
            rm -rf "$target_dir"
            # modulefiles/app/version
            rm -rf "$script_path"
            rm -rf "${script_path}.lua"

            # If the app directory is empty, remove it
            if [ -z "$(ls -A $app_base_dir)" ]; then
                printf "[`date +"%Y-%m-%d %T"`] App directory is empty. Removing $app_base_dir\n"
                rm -rf "$app_base_dir"
            fi
            # If the modulefiles/app directory is empty, remove it
            if [ -z "$(ls -A $script_base_dir)" ]; then
                printf "[`date +"%Y-%m-%d %T"`] Modulefiles directory is empty. Removing $script_base_dir\n"
                rm -rf "$script_base_dir"
            fi
            exit
            ;;
        \? )
            echo "Invalid Option: -$OPTARG" 1>&2
            exit 1
            ;;
    esac
done

printf "[`date +"%Y-%m-%d %T"`] Start building ${RED}${app_name}${NC} version ${RED}${version}${NC}\n"
printf "[`date +"%Y-%m-%d %T"`] Target App Directory: $target_dir\n"
printf "[`date +"%Y-%m-%d %T"`] Target Module Script Path: $script_path\n"

if [ -d "$target_dir" ]; then
    printf "[`date +"%Y-%m-%d %T"`] ${RED}ERROR${NC}: Target app exists!\n"  1>&2
    printf "[`date +"%Y-%m-%d %T"`] Exit Building\n"
    exit 1
fi

# Function to run a command and exit if it fails
run_command() {
    "$@"
    if [ $? -ne 0 ]; then
        echo "[`date +"%Y-%m-%d %T"`] Link expired! Get the link from https://www.10xgenomics.com/support/software/cell-ranger/downloads/previous-versions"
        echo "[`date +"%Y-%m-%d %T"`] And change the line 104"
        echo "[`date +"%Y-%m-%d %T"`] Removing target directory: $target_dir"
        rm -rf "$target_dir"
        exit 1
    fi
}
#endregion CONFIGS

#region BUILD SCRIPT
# pwd: modules/
echo [`date +"%Y-%m-%d %T"`] Downloading cellranger-${version}.tar.gz
run_command wget -O cellranger-9.0.0.tar.gz "https://cf.10xgenomics.com/releases/cell-exp/cellranger-9.0.0.tar.gz?Expires=1732092276&Key-Pair-Id=APKAI7S6A5RYOXBWRPDA&Signature=UijFtHYX1dFJO8sYXDWFxY3eIXn1iUhMsSmcIGzkewJ4u164R~w16luwLbyrklkf8csJQeX7mguIZ1U1CqSzKZTUtrcTHMfmFBr0vmXmY4JPWRWw4X2PUWTCRKsFIbkImOo1wlgKjK3U8WQZKt~wkj4IFsuIesRY1IL51PkA3tzWQXqmx-cF21LD86UzKyDSAhce-KihvzDN6u4bxWvJ7hlEH67a23usHalSqaMn5QMTwdkrOWIq7Et42vtmj-g7hhijml8DichF4DvhynOTCzbEUq171NJkAzbjAl~SzNa3CkA5K5z~tn6xZBxfE3EH-6vVvcOV6gRHTBsLO9vAbQ__"

printf "[`date +"%Y-%m-%d %T"`] Extracting cellranger-${version}.tar.gz\n"
tar xf ./cellranger-${version}.tar.gz
rm ./cellranger-${version}.tar.gz

# move to software/version folder
mkdir -p cellranger
mv cellranger-${version}/ cellranger/${version}
#endregion BUILD SCRIPT

# Cell Ranger References
mkdir -p cellranger/ref
echo [`date +"%Y-%m-%d %T"`] Downloading Cell Ranger Reference if needed

if ! [ -d "cellranger/ref/refdata-gex-GRCh38-2024-A" ]; then
    echo [`date +"%Y-%m-%d %T"`] Downloading refdata-gex-GRCh38-2024-A
    wget -nv "https://cf.10xgenomics.com/supp/cell-exp/refdata-gex-GRCh38-2024-A.tar.gz"
    tar xf refdata-gex-GRCh38-2024-A.tar.gz -C cellranger/ref
    rm refdata-gex-GRCh38-2024-A.tar.gz
fi
if ! [ -d "cellranger/ref/refdata-gex-GRCm39-2024-A" ]; then
    echo [`date +"%Y-%m-%d %T"`] Downloading refdata-gex-GRCm39-2024-A
    wget -nv "https://cf.10xgenomics.com/supp/cell-exp/refdata-gex-GRCm39-2024-A.tar.gz"
    tar xf refdata-gex-GRCm39-2024-A.tar.gz -C cellranger/ref
    rm refdata-gex-GRCm39-2024-A.tar.gz
fi

#region Copying modulefiles
printf "[`date +"%Y-%m-%d %T"`] Copying modulefiles\n"
mkdir -p "$script_base_dir"
if [ -f "${modules_root}/build-scripts/${app_name}/template" ]; then
    printf "[`date +"%Y-%m-%d %T"`] $app_name specific template exists. Use it.\n"
    cp "${modules_root}/build-scripts/${app_name}/template" "$script_path"
    cp "${modules_root}/build-scripts/${app_name}/template.lua" "${script_path}.lua"
else
    printf "[`date +"%Y-%m-%d %T"`] $app_name specific template does exist. Use default template.\n"
    cp "${modules_root}/build-scripts/template" "$script_path"
    cp "${modules_root}/build-scripts/template.lua" "${script_path}.lua"
fi
#endregion

printf "[`date +"%Y-%m-%d %T"`] End building ${RED}${app_name}${NC} version ${RED}${version}${NC}\n"
